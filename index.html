<!DOCTYPE html>
<html>
    <head>
        <title>Crimes in U.S. Institutions</title>
        <style type  = "text/css">
            div.tooltip{
                position: absolute;
                text-align: center;
                width: 100px;
                height: 28px;
                padding: 2px;
                font: 12px sans-serif;
                background: rgb(0, 255, 150);
                border: 0px;
                border-radius: 8px;
                pointer-events: none;
            }
            .axis{
                fill: none;
                stroke: black;
            }
            .axis text{
                fill: black;
                stroke: none;
                font-size: 12px;
            }
        </style>
    </head>
    <body>
        <h1>Crimes in U.S. University</h1>
        <script src="https://d3js.org/d3.v3.min.js"></script>
        <script src="https://d3js.org/topojson.v1.min.js"></script>
        <script src="https://d3js.org/queue.v1.min.js"></script>
        <script>
            var USMap, div, USMapS, projection, path, projection2, path2, arc, donutChart, pathForDonut, originalDataForDonut, dataForDonut, donutData, drawDonut, dataForGenderBar, genderBarWidth, genderBar, genderBarYScale, genderBarYAxisScale, genderBarFlag, smallMapFlag, dataForCrimeBar, crimeBarWidth, crimeBar, crimeBarYScale, crimeBarYAxisScale, crimeBarFlag, dataForInstitutionBar, institutionBarWidth, institutionBar, institutionBarYScale, institutionBarYAxisScale, institutionBarFlag;
            var dataForDonut = [];
            var barXScale = d3.scale.linear()
            .domain([0, 100])
            .range([0, 352]);
            //SVG
            var svg = d3.select("body").append("svg")
            .classed("chart", true)
            .attr("width", 1272)
            .attr("height", 560);
            
            var container = svg.append("g").classed("container-group", true);
            container.append("g").classed("chart-group", true);
            
            projection = d3.geo.albersUsa()
            .translate([636, 250])
            .scale([1000]);
            
            path = d3.geo.path().projection(projection);
            
            queue()
            .defer(d3.json, "Data/states.json")
            .defer(d3.csv, "Data/crimeDevidedByStates.csv")
            .defer(d3.csv, "Data/schoolType.csv")
            .await(mapping);
            
            function mapping(error, states, crimeDevidedByStates, schoolType){
                if (error){
                    console.log(error);
                }
                
                div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);
                
                var dataset = [];
                var colorFlag;
                var color = d3.scale.threshold()
                .domain([0, 73, 146, 219, 292, 365, 438, 511, 584, 657])
                .range(["black", "#ffffe5", "#f7fcb9", "#d9f0a3", "#addd8e", "#78c679", "#41ab5d", "#238443", "#006837", "#004529"]);
                
                for (var i = 0; i < crimeDevidedByStates.length; i++){
                    dataset[i] = [];
                    dataset[i][0] = +crimeDevidedByStates[i].ID;
                    dataset[i][1] = crimeDevidedByStates[i].State;
                    dataset[i][2] = +crimeDevidedByStates[i].Total;
                    dataset[i][3] = +crimeDevidedByStates[i].Male;
                    dataset[i][4] = +crimeDevidedByStates[i].Female;
                    dataset[i][5] = crimeDevidedByStates[i].StateFull;
                    dataset[i][6] = +crimeDevidedByStates[i].InstitutionNumber;
                    dataset[i][7] = +schoolType[i].PrivateNonProfit4YM;
                    dataset[i][8] = +schoolType[i].Public2Y;
                    dataset[i][9] = +schoolType[i].Public4YM;
                    dataset[i][10] = +schoolType[i].PrivateForProfit4YM;
                    dataset[i][11] = +schoolType[i].PrivateNonProfit2Y;
                    dataset[i][12] = +schoolType[i].PrivateForProfit2Y;
                    dataset[i][13] = +schoolType[i].Public2YL;
                    dataset[i][14] = +schoolType[i].PrivateForProfit2YL;
                    dataset[i][15] = +schoolType[i].PrivateNonProfit2YL;
                }
                
                d3.selection.prototype.moveToFront = function(){
                    return this.each(function(){
                        this.parentNode.appendChild(this);
                    });
                };
                
                //Donut Chart
                originalDataForDonut = [];
                for (var i = 0; i < 9; i++){
                    originalDataForDonut[i] = 1;
                }
                
                var donutColor = ["#fbb4ae", "#b3cde3", "#ccebc5", "#decbe4", "#fed9a6", "#ffffcc", "#e5d8bd", "#fddaec", "#f2f2f2"];
                
                var schoolTypeName = ["Private Non-Profit 4Y+", "Public 2Y", "Public 4Y+", "Private For-Profit 4Y+", "Private Non-Profit 2Y", "Private For Profit 2Y", "Public 2Y-", "Private For-Profit 2Y-", "Privat Non-Profti 2Y-"];
                
                donutChart = d3.layout.pie()
                .sort(null);
                donutData = donutChart(originalDataForDonut);
                arc = d3.svg.arc()
                .outerRadius(90)
                .innerRadius(50);
                drawDonut = svg.selectAll(".donut")
                .data(donutData)
                .enter()
                .append("path")
                .attr("d", arc)
                .attr("transform", "translate(900, 150)")
                .attr("fill", function(d, i){
                      return donutColor[i];
                })
                .style("opacity", 0)
                .on("mouseover", function(d, i){
                    if (d3.select(this).style("opacity") == 1){
                        d3.select(this).transition()
                        .duration(200)
                        .attr("fill", "orange");
                    
                        div.transition()
                        .duration(200)
                        .style("opacity", 0.8);
                    
                        div.html(schoolTypeName[i] + "<br/>" + dataForDonut[i] + " Institutions")
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                    }
                })
                .on("mouseout", function(d, i){
                    if (d3.select(this).style("opacity") == 1){
                        d3.select(this).transition()
                        .duration(500)
                        .attr("fill", donutColor[i]);
                    
                        div.transition()
                        .duration(500)
                        .style("opacity", 0);
                    }
                });
                
                //Gender Ratio Bar
                dataForGenderBar = [];
                for (var i = 0; i < crimeDevidedByStates.length; i++){
                    dataForGenderBar[i] = dataset[i][3] / dataset[i][4];
                }
                
                genderBarWidth = 350 / crimeDevidedByStates.length;
                genderBar = svg.selectAll(".chart-group")
                .selectAll(".bar")
                .data(dataForGenderBar)
                .enter()
                .append("rect");
                
                genderBarYScale = d3.scale.linear()
                .domain([0.5, 1.1])
                .range([0, 200]);
                var genderBarXAxis = svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(28, 550)")
                .style("opacity", 0)
                .call(d3.svg.axis()
                    .scale(barXScale)
                    .orient("bottom")
                    .ticks(0)
                );
                genderBarYAxisScale = d3.scale.linear()
                .domain([0.5, 1.1])
                .range([200, 0]);
                var genderBarYAxis = svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(28, 350)")
                .style("opacity", 0)
                .call(d3.svg.axis()
                    .scale(genderBarYAxisScale)
                    .orient("left")
                    .ticks(5)
                );
                
                //Crime Number Bar
                dataForCrimeBar = [];
                for (var i = 0; i < crimeDevidedByStates.length; i++){
                    dataForCrimeBar[i] = dataset[i][2];
                }
                
                crimeBarWidth = 350 / crimeDevidedByStates.length;
                crimeBar = svg.selectAll(".chart-group")
                .selectAll(".bar")
                .data(dataForCrimeBar)
                .enter()
                .append("rect");
                
                crimeBarYScale = d3.scale.linear()
                .domain([0, 680])
                .range([0, 200]);
                var crimeBarXAxis = svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(461, 550)")
                .style("opacity", 0)
                .call(d3.svg.axis()
                    .scale(barXScale)
                    .orient("bottom")
                    .ticks(0)
                );
                crimeBarYAxisScale = d3.scale.linear()
                .domain([0, 680])
                .range([200, 0]);
                var crimeBarYAxis = svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(461, 350)")
                .style("opacity", 0)
                .call(d3.svg.axis()
                    .scale(crimeBarYAxisScale)
                    .orient("left")
                    .ticks(5)
                );
                
                //Institution Number Bar
                dataForInstitutionBar = [];
                for (var i = 0; i < crimeDevidedByStates.length; i++){
                    dataForInstitutionBar[i] = dataset[i][6];
                }
                
                institutionBarWidth = 350 / crimeDevidedByStates.length;
                institutionBar = svg.selectAll(".chart-group")
                .selectAll(".bar")
                .data(dataForInstitutionBar)
                .enter()
                .append("rect");
                
                institutionBarYScale = d3.scale.linear()
                .domain([0, 160])
                .range([0, 200]);
                var institutionBarXAxis = svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(894, 550)")
                .style("opacity", 0)
                .call(d3.svg.axis()
                    .scale(barXScale)
                    .orient("bottom")
                    .ticks(0)
                );
                institutionBarYAxisScale = d3.scale.linear()
                .domain([0, 160])
                .range([200, 0]);
                var institutionBarYAxis = svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(894, 350)")
                .style("opacity", 0)
                .call(d3.svg.axis()
                    .scale(institutionBarYAxisScale)
                    .orient("left")
                    .ticks(5)
                );
                
                // Big U.S. Map
                USMap = svg.selectAll("pathUS")
                .data(states.features)
                .enter()
                .append("path")
                .attr("stroke-width", 1)
                .attr("stroke", "#ccc")
                .attr("d", path)
                .attr("id", function(d){
                      return "s" + d.id;
                })
                .on("mouseover", function(d, i){
                    if (d3.select(this).style("opacity") == 1){
                        d3.select(this).transition()
                        .duration(200)
                        .attr("fill", "orange");
                    
                        div.transition()
                        .duration(200)
                        .style("opacity", 0.8);
                    
                        for (var i = 0; i < dataset.length; i++){
                            if (d.id == dataset[i][0]){
                                div.html(d.properties.name + "<br/>" + dataset[i][2] + " Crimes")
                                .style("left", (d3.event.pageX) + "px")
                                .style("top", (d3.event.pageY - 28) + "px");
                                colorFlag = dataset[i][2];
                            }
                        }
                    }
                })
                .on("mouseout", function(d){
                    if (d3.select(this).style("opacity") == 1){
                        d3.select(this).transition()
                        .duration(500)
                        .attr("fill", color(colorFlag));
                    
                        div.transition()
                        .duration(500)
                        .style("opacity", 0);
                    }
                })
                .on("click", function(d, i){
                    if (d3.select(this).style("opacity") == 1){
                        for (var i = 0; i < crimeDevidedByStates.length; i++){
                            d3.select("#ss" + crimeDevidedByStates[i].ID).moveToFront();
                            d3.select("#s" + crimeDevidedByStates[i].ID).attr("fill", color(+crimeDevidedByStates[i].Total));
                        }
                    
                        for (var i = 0; i < dataset.length; i++){
                            if(d.id == dataset[i][0]){
                                dataForDonut[0] = dataset[i][7];
                                dataForDonut[1] = dataset[i][8];
                                dataForDonut[2] = dataset[i][9];
                                dataForDonut[3] = dataset[i][10];
                                dataForDonut[4] = dataset[i][11];
                                dataForDonut[5] = dataset[i][12];
                                dataForDonut[6] = dataset[i][13];
                                dataForDonut[7] = dataset[i][14];
                                dataForDonut[8] = dataset[i][15];
                                genderBarFlag = i;
                                crimeBarFlag = i;
                                institutionBarFlag = i;
                            }
                        }
                    
                        USMap.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        div.transition()
                        .duration(500)
                        .style("opacity", 0);
                    
                        USMapS.transition()
                        .duration(500)
                        .style("opacity", 1);
                    
                        //Donut Chart
                        donutData = donutChart(dataForDonut);
                        drawDonut.data(donutData)
                        .attr("d", arc);
                    
                        //Gender Ratio Bar
                        genderBar.transition()
                        .duration(500)
                        .each("start", function(){
                            d3.select(this)
                            .attr("y", 550 - 200)
                            .attr("height", 200)
                            .attr("fill", "orange");
                        })
                        .delay(function(d, i){
                            return i / dataForGenderBar.length * 500;
                        })
                        .attr("x", function(d, i){
                            return i * genderBarWidth + 30;
                        })
                        .attr("width", genderBarWidth - 2)
                        .attr("id", function(d, i){
                            return "genderBar" + i;
                        })
                        .each("end", function(){
                            d3.select(this)
                            .transition()
                            .duration(300)
                            .attr("y", function(d){
                                return 550 - genderBarYScale(d);
                            })
                            .attr("height", function(d){
                                return genderBarYScale(d);
                            })
                            .attr("fill", function(d){
                                if (d3.select(this).attr("id").substr(9) != genderBarFlag){
                                    return "rgba(0, 0, 255, 0.5)";
                                }
                                else{
                                    return "orange";
                                }
                            });
                            d3.select(this)
                            .on("mouseover", function(d, i){
                                if (d3.select(this).style("opacity") == 1){
                                    var tip = d3.select(this).attr("id").substr(9);
                                    tip = +tip;
                                    for (var i = 0; i < dataset.length; i++){
                                        if (i != tip){
                                            d3.select("#genderBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                        }
                                    }
                                    d3.select(this).attr("fill", "orange");
                                    div.transition()
                                    .duration(200)
                                    .style("opacity", 0.8);
                                    div.html(dataset[tip][5] + "<br/>"  + d)
                                    .style("left", (d3.event.pageX) + "px")
                                    .style("top", (d3.event.pageY - 28) + "px");
                                
                                    for (var i = 0; i < dataset.length; i++){
                                        if (smallMapFlag == dataset[i][0]){
                                            d3.select("#ss" + smallMapFlag).attr("fill", color(+crimeDevidedByStates[i].Total));
                                            d3.select("#crimeBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                            d3.select("#institutionBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                        }
                                    }
                                
                                    for (var i = 0; i < dataset.length; i++){
                                        if (i == tip){
                                            d3.select("#ss" + crimeDevidedByStates[i].ID).attr("fill", "orange");
                                            d3.select("#crimeBar" + i).attr("fill", "orange");
                                            d3.select("#institutionBar" + i).attr("fill", "orange");
                                            dataForDonut[0] = dataset[i][7];
                                            dataForDonut[1] = dataset[i][8];
                                            dataForDonut[2] = dataset[i][9];
                                            dataForDonut[3] = dataset[i][10];
                                            dataForDonut[4] = dataset[i][11];
                                            dataForDonut[5] = dataset[i][12];
                                            dataForDonut[6] = dataset[i][13];
                                            dataForDonut[7] = dataset[i][14];
                                            dataForDonut[8] = dataset[i][15];
                                        }
                                    }
                                
                                    donutData = donutChart(dataForDonut);
                                    drawDonut.data(donutData)
                                    .attr("d", arc);
                                }
                            })
                            .on("mouseout", function(d){
                                if (d3.select(this).style("opacity") == 1){
                                    d3.select(this).attr("fill", "rgba(0, 0, 255, 0.5)");
                                    div.transition()
                                    .duration(500)
                                    .style("opacity", 0);
                                    var tip = d3.select(this).attr("id").substr(9);
                                    tip = +tip;
                                    for (var i = 0; i < dataset.length; i++){
                                        if (i == tip){
                                            d3.select("#ss" + crimeDevidedByStates[i].ID).attr("fill", color(+crimeDevidedByStates[i].Total));
                                            d3.select("#crimeBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                            d3.select("#institutionBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                        }
                                    }
                                
                                }
                            });
                        });
                            
                        //Crime Bar
                        crimeBar.transition()
                        .duration(500)
                        .each("start", function(){
                            d3.select(this)
                            .attr("y", 550 - 200)
                            .attr("height", 200)
                            .attr("fill", "orange");
                        })
                        .delay(function(d, i){
                            return i / dataForCrimeBar.length * 500;
                        })
                        .attr("x", function(d, i){
                            return i * crimeBarWidth + 463;
                        })
                        .attr("width", crimeBarWidth - 2)
                        .attr("id", function(d, i){
                            return "crimeBar" + i;
                        })
                        .each("end", function(){
                            d3.select(this)
                            .transition()
                            .duration(300)
                            .attr("y", function(d){
                                return 550 - crimeBarYScale(d);
                            })
                            .attr("height", function(d){
                                return crimeBarYScale(d);
                            })
                            .attr("fill", function(d){
                                if (d3.select(this).attr("id").substr(8) != crimeBarFlag){
                                    return "rgba(0, 0, 255, 0.5)";
                                }
                                else{
                                    return "orange";
                                }
                            });
                            d3.select(this)
                            .on("mouseover", function(d, i){
                                if (d3.select(this).style("opacity") == 1){
                                    var tip = d3.select(this).attr("id").substr(8);
                                    tip = +tip;
                                    for (var i = 0; i < dataset.length; i++){
                                        if (i != tip){
                                            d3.select("#crimeBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                        }
                                    }
                                    d3.select(this).attr("fill", "orange");
                                    div.transition()
                                    .duration(200)
                                    .style("opacity", 0.8);
                                    div.html(dataset[tip][5] + "<br/>"  + d + " Crimes")
                                    .style("left", (d3.event.pageX) + "px")
                                    .style("top", (d3.event.pageY - 28) + "px");
                                
                                    for (var i = 0; i < dataset.length; i++){
                                        if (smallMapFlag == dataset[i][0]){
                                            d3.select("#ss" + smallMapFlag).attr("fill", color(+crimeDevidedByStates[i].Total));
                                            d3.select("#genderBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                            d3.select("#institutionBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                        }
                                    }
                                
                                    for (var i = 0; i < dataset.length; i++){
                                        if (i == tip){
                                            d3.select("#ss" + crimeDevidedByStates[i].ID).attr("fill", "orange");
                                            d3.select("#genderBar" + i).attr("fill", "orange");
                                            d3.select("#institutionBar" + i).attr("fill", "orange");
                                            dataForDonut[0] = dataset[i][7];
                                            dataForDonut[1] = dataset[i][8];
                                            dataForDonut[2] = dataset[i][9];
                                            dataForDonut[3] = dataset[i][10];
                                            dataForDonut[4] = dataset[i][11];
                                            dataForDonut[5] = dataset[i][12];
                                            dataForDonut[6] = dataset[i][13];
                                            dataForDonut[7] = dataset[i][14];
                                            dataForDonut[8] = dataset[i][15];
                                        }
                                    }
                                
                                    donutData = donutChart(dataForDonut);
                                    drawDonut.data(donutData)
                                    .attr("d", arc);
                                }
                            })
                            .on("mouseout", function(d){
                                if (d3.select(this).style("opacity") == 1){
                                    d3.select(this).attr("fill", "rgba(0, 0, 255, 0.5)");
                                    div.transition()
                                    .duration(500)
                                    .style("opacity", 0);
                                    var tip = d3.select(this).attr("id").substr(8);
                                    tip = +tip;
                                    for (var i = 0; i < dataset.length; i++){
                                        if (i == tip){
                                            d3.select("#ss" + crimeDevidedByStates[i].ID).attr("fill", color(+crimeDevidedByStates[i].Total));
                                            d3.select("#genderBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                            d3.select("#institutionBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                        }
                                    }
                                }
                            });
                        });
                    
                        //Institution Bar
                        institutionBar.transition()
                        .duration(500)
                        .each("start", function(){
                            d3.select(this)
                            .attr("y", 550 - 200)
                            .attr("height", 200)
                            .attr("fill", "orange");
                        })
                        .delay(function(d, i){
                            return i / dataForInstitutionBar.length * 500;
                        })
                        .attr("x", function(d, i){
                            return i * institutionBarWidth + 896;
                        })
                        .attr("width", institutionBarWidth - 2)
                        .attr("id", function(d, i){
                            return "institutionBar" + i;
                        })
                        .each("end", function(){
                            d3.select(this)
                            .transition()
                            .duration(300)
                            .attr("y", function(d){
                                return 550 - institutionBarYScale(d);
                            })
                            .attr("height", function(d){
                                return institutionBarYScale(d);
                            })
                            .attr("fill", function(d){
                                if (d3.select(this).attr("id").substr(14) != institutionBarFlag){
                                    return "rgba(0, 0, 255, 0.5)";
                                }
                                else{
                                    return "orange";
                                }
                            });
                            d3.select(this)
                            .on("mouseover", function(d, i){
                                if (d3.select(this).style("opacity") == 1){
                                    var tip = d3.select(this).attr("id").substr(14);
                                    tip = +tip;
                                    for (var i = 0; i < dataset.length; i++){
                                        if (i != tip){
                                            d3.select("#institutionBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                        }
                                    }
                                    d3.select(this).attr("fill", "orange");
                                    div.transition()
                                    .duration(200)
                                    .style("opacity", 0.8);
                                    div.html(dataset[tip][5] + "<br/>"  + d + " Institutions")
                                    .style("left", (d3.event.pageX) + "px")
                                    .style("top", (d3.event.pageY - 28) + "px");
                                
                                    for (var i = 0; i < dataset.length; i++){
                                        if (smallMapFlag == dataset[i][0]){
                                            d3.select("#ss" + smallMapFlag).attr("fill", color(+crimeDevidedByStates[i].Total));
                                            d3.select("#genderBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                            d3.select("#crimeBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                        }
                                    }
                                
                                    for (var i = 0; i < dataset.length; i++){
                                        if (i == tip){
                                            d3.select("#ss" + crimeDevidedByStates[i].ID).attr("fill", "orange");
                                            d3.select("#genderBar" + i).attr("fill", "orange");
                                            d3.select("#crimeBar" + i).attr("fill", "orange");
                                            dataForDonut[0] = dataset[i][7];
                                            dataForDonut[1] = dataset[i][8];
                                            dataForDonut[2] = dataset[i][9];
                                            dataForDonut[3] = dataset[i][10];
                                            dataForDonut[4] = dataset[i][11];
                                            dataForDonut[5] = dataset[i][12];
                                            dataForDonut[6] = dataset[i][13];
                                            dataForDonut[7] = dataset[i][14];
                                            dataForDonut[8] = dataset[i][15];
                                        }
                                    }
                                
                                    donutData = donutChart(dataForDonut);
                                    drawDonut.data(donutData)
                                    .attr("d", arc);
                                }
                            })
                            .on("mouseout", function(d){
                                if (d3.select(this).style("opacity") == 1){
                                    d3.select(this).attr("fill", "rgba(0, 0, 255, 0.5)");
                                    div.transition()
                                    .duration(500)
                                    .style("opacity", 0);
                                    var tip = d3.select(this).attr("id").substr(14);
                                    tip = +tip;
                                    for (var i = 0; i < dataset.length; i++){
                                        if (i == tip){
                                            d3.select("#ss" + crimeDevidedByStates[i].ID).attr("fill", color(+crimeDevidedByStates[i].Total));
                                            d3.select("#genderBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                            d3.select("#crimeBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                        }
                                    }
                                }
                            });
                        });

                    
                        //Opacity
                        genderBarXAxis.transition()
                        .duration(500)
                        .style("opacity", 1);
                        genderBarYAxis.transition()
                        .duration(500)
                        .style("opacity", 1);
                        genderBar.style("opacity", 1);
                        genderBarXAxis.moveToFront();
                        genderBarYAxis.moveToFront();
                        genderBar.moveToFront();
                    
                        crimeBarXAxis.transition()
                        .duration(500)
                        .style("opacity", 1);
                        crimeBarYAxis.transition()
                        .duration(500)
                        .style("opacity", 1);
                        crimeBar.style("opacity", 1);
                        crimeBarXAxis.moveToFront();
                        crimeBarYAxis.moveToFront();
                        crimeBar.moveToFront();
                    
                        institutionBarXAxis.transition()
                        .duration(500)
                        .style("opacity", 1);
                        institutionBarYAxis.transition()
                        .duration(500)
                        .style("opacity", 1);
                        institutionBar.style("opacity", 1);
                        institutionBarXAxis.moveToFront();
                        institutionBarYAxis.moveToFront();
                        institutionBar.moveToFront();
                    
                        drawDonut.transition()
                        .duration(500)
                        .style("opacity", 1);
                        drawDonut.moveToFront();
                    
                        d3.select("#ss" + d.id).attr("fill", "orange");
                        smallMapFlag = d.id;
                    
                    }
                });
                
                for (var i = 0; i < crimeDevidedByStates.length; i++){
                    d3.select("#s" + crimeDevidedByStates[i].ID).attr("fill", color(+crimeDevidedByStates[i].Total));
                }
                
                //Small U.S. Map
                projection2 = d3.geo.albersUsa()
                .translate([350, 150])
                .scale([600]);
                
                path2 = d3.geo.path().projection(projection2);
                
                USMapS = svg.selectAll("pathUS")
                .data(states.features)
                .enter()
                .append("path")
                .attr("stroke-width", 1)
                .attr("stroke", "#ccc")
                .attr("d", path2)
                .attr("id", function(d){
                      return "ss" + d.id;
                })
                .style("opacity", 0)
                .on("mouseover", function(d, i){
                    if (d3.select(this).style("opacity") == 1){
                        d3.select(this).transition()
                        .duration(200)
                        .attr("fill", "orange");
                    
                        div.transition()
                        .duration(200)
                        .style("opacity", 0.8);
                    
                        for (var i = 0; i < dataset.length; i++){
                            if (d.id == dataset[i][0]){
                                div.html(d.properties.name + "<br/>" + dataset[i][2] + " Crimes")
                                .style("left", (d3.event.pageX) + "px")
                                .style("top", (d3.event.pageY - 28) + "px");
                                colorFlag = dataset[i][2];
                                dataForDonut[0] = dataset[i][7];
                                dataForDonut[1] = dataset[i][8];
                                dataForDonut[2] = dataset[i][9];
                                dataForDonut[3] = dataset[i][10];
                                dataForDonut[4] = dataset[i][11];
                                dataForDonut[5] = dataset[i][12];
                                dataForDonut[6] = dataset[i][13];
                                dataForDonut[7] = dataset[i][14];
                                dataForDonut[8] = dataset[i][15];
                                genderBarFlag = i;
                            }
                        }
                        for (var i = 0; i < dataset.length; i++){
                            if (i != genderBarFlag){
                                d3.select("#genderBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                d3.select("#crimeBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                d3.select("#institutionBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                            }
                            else{
                                d3.select("#genderBar" + i).attr("fill", "orange");
                                d3.select("#crimeBar" + i).attr("fill", "orange");
                                d3.select("#institutionBar" + i).attr("fill", "orange");
                            }
                        }
                        for (var i = 0; i < dataset.length; i++){
                            if (smallMapFlag == dataset[i][0]){
                                d3.select("#ss" + smallMapFlag).attr("fill", color(+crimeDevidedByStates[i].Total));
                            }
                        }
                    
                        donutData = donutChart(dataForDonut);
                        drawDonut.data(donutData)
                        .attr("d", arc);
                    }
                })
                .on("mouseout", function(d){
                    if (d3.select(this).style("opacity") == 1){
                        d3.select(this).transition()
                        .duration(500)
                        .attr("fill", color(colorFlag));
                    
                        div.transition()
                        .duration(500)
                        .style("opacity", 0);
                    
                        for (var i = 0; i < dataset.length; i++){
                            d3.select("#genderBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                            d3.select("#crimeBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                            d3.select("#institutionBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                        }
                    
                    }
                })
                .on("click", function(d){
                    if (d3.select(this).style("opacity") == 1){
                        for (var i = 0; i < crimeDevidedByStates.length; i++){
                            d3.select("#s" + crimeDevidedByStates[i].ID).moveToFront();
                            d3.select("#ss" + crimeDevidedByStates[i].ID).attr("fill", color(+crimeDevidedByStates[i].Total));
                        }
                    
                        USMap.transition()
                        .duration(500)
                        .style("opacity", 1);
                    
                        div.transition()
                        .duration(500)
                        .style("opacity", 0);
                    
                        USMapS.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        genderBar.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        genderBarXAxis.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        genderBarYAxis.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        crimeBar.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        crimeBarXAxis.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        crimeBarYAxis.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        institutionBar.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        institutionBarXAxis.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        institutionBarYAxis.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        drawDonut.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                    }
                });
                
                for (var i = 0; i < crimeDevidedByStates.length; i++){
                    d3.select("#ss" + crimeDevidedByStates[i].ID).attr("fill", color(+crimeDevidedByStates[i].Total));
                }
                
                for (var i = 0; i < crimeDevidedByStates.length; i++){
                    d3.select("#s" + crimeDevidedByStates[i].ID).moveToFront();
                }

            }
        </script>
    </body>
</html>
