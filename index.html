<!DOCTYPE html>
<html>
    <head>
        <title>Crimes in U.S. Institutions</title>
        <style type  = "text/css">
            .section{
                font-size: 6em;
                text-align: center;
            }
            #menu li a,a{
                text-decoration:none;
            }
            #menu{
                z-index:70;
                position:fixed;
            }
            #menu li{
                display:inline-block;
                margin:10px;
                color:#000;
                background:#fff;
                background:rgba(255,255,255,.5);
                -webkit-border-radius:10px;
                border-radius:10px;
            }
            #menu li a, a:hover{
                color:#000;
            }
            #menu li:hover{
                background:rgba(255,255,255,.8);
            }
            #menu li a{
                padding:9px 18px;
                display:block;
            }
            #menu{
                padding:0;
            }
            #menu{
                top:0;
                left:0;
                height:40px;
                width:100%;
                margin:0;
            }
            div.tooltip{
                position: absolute;
                text-align: center;
                width: 100px;
                height: 28px;
                padding: 2px;
                font: 12px sans-serif;
                background: rgb(0, 255, 150);
                border: 0px;
                border-radius: 8px;
                pointer-events: none;
            }
            .axis{
                fill: none;
                stroke: black;
            }
            .axis text{
                fill: black;
                stroke: none;
                font-size: 12px;
            }
            pathFilter {
                stroke-width: 0.25px;
            }
            div.tooltipFilter {
                position: absolute;
                text-align: center;
                width: 100px;
                height: 30px;
                padding: 2px;
                font: 13px sans-serif;
                background: white;
                border: 2px;
                border-radius: 5px;
                pointer-events: none;
            }
        </style>
    </head>
    <body>
        <link rel="stylesheet" type="text/css" href="Data/jquery.fullPage.css/" />
        <script src="Data/jquery.min.js"></script>
        <script type="text/javascript" src="Data/jquery.fullPage.js"></script>
        <script src="https://d3js.org/d3.v3.min.js"></script>
        <script src="https://d3js.org/topojson.v1.min.js"></script>
        <script src="https://d3js.org/queue.v1.min.js"></script>
        <script type="text/javascript">
            $(document).ready(function(){
                $('#fullpage').fullpage({
                    sectionsColor: ['#f2f2f2', '#4BBFC3', '#7BAABE', 'whitesmoke', '#000'],
                    anchors:['section1', 'section2', 'section3'],
                    menu: '#menu'
                });
            });
        </script>
        <ul id="menu">
            <li><a href="#section1">First section</a></li>
            <li><a href="#section2">Second section</a></li>
            <li><a href="#section3">Third section</a></li>
        </ul>
        <div id="fullpage">
            <div class="section" id="part1"/></div>
            <div class="section" id="part2"></div>
            <div class="section" id="part3"></div>
        </div>
        <script>
            var USMap, div, USMapS, projection, path, projection2, path2, arc, donutChart, pathForDonut, originalDataForDonut, dataForDonut, donutData, drawDonut, dataForGenderBar, genderBarWidth, genderBar, genderBarYScale, genderBarYAxisScale, genderBarFlag, smallMapFlag, dataForCrimeBar, crimeBarWidth, crimeBar, crimeBarYScale, crimeBarYAxisScale, crimeBarFlag, dataForInstitutionBar, institutionBarWidth, institutionBar, institutionBarYScale, institutionBarYAxisScale, institutionBarFlag;
            var dataForDonut = [];
            var barXScale = d3.scale.linear()
            .domain([0, 100])
            .range([0, 352]);
            //SVG
            var svg = d3.select("#part1").append("svg")
            .classed("chart", true)
            .attr("width", 1272)
            .attr("height", 560);
            
            var container = svg.append("g").classed("container-group", true);
            container.append("g").classed("chart-group", true);
            
            projection = d3.geo.albersUsa()
            .translate([636, 250])
            .scale([1000]);
            
            path = d3.geo.path().projection(projection);
            
            //SVG2
            var widthFilter = 1272,
            heightFilter = 560,
            centeredFilter;
            
            var projectionFilter = d3.geo.albersUsa()
            .translate([636, 250])
            .scale([1000]);
            
            var svgFilter = d3.select("#part2").append("svg")
            .attr("width", widthFilter)
            .attr("height", heightFilter)
            .style('display','block')
            .style('margin', 'auto');
            
            var pathFilter = d3.geo.path()
            .projection(projectionFilter);
            
            var gFilter = svgFilter.append("g");
            
            var divFilter = d3.select("body")
            .append("div")
            .attr("class", "tooltipFilter")
            .style("opacity", 0.7);
            
            var colorFilter = d3.scale.threshold()
            .domain([0, 20, 40, 60, 80, 100, 120, 140, 160, 180])
            .range(['#f7fbff','#deebf7','#c6dbef','#9ecae1','#6baed6','#4292c6','#2171b5','#08519c','#08306b', 'black']);
            
            svgFilter.append("text")
            .attr("x", 150)
            .attr("y", 30).style("font-size", "25px")
            .text("The Distribution of Institution")
            .attr("pointer-events", "none");
            
            queue()
            .defer(d3.json, "Data/states.json")
            .defer(d3.csv, "Data/crimeDevidedByStates.csv")
            .defer(d3.csv, "Data/schoolType.csv")
            .defer(d3.csv, "Data/dataset.csv")
            .defer(d3.csv, "Data/sum.csv")
            .await(mapping);
            
            function mapping(error, states, crimeDevidedByStates, schoolType, datasetFull, sum){
                if (error){
                    console.log(error);
                }
                
                div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);
                
                var dataset = [];
                var colorFlag;
                var color = d3.scale.threshold()
                .domain([0, 73, 146, 219, 292, 365, 438, 511, 584, 657])
                .range(["black", "#ffffe5", "#f7fcb9", "#d9f0a3", "#addd8e", "#78c679", "#41ab5d", "#238443", "#006837", "#004529"]);
                
                for (var i = 0; i < crimeDevidedByStates.length; i++){
                    dataset[i] = [];
                    dataset[i][0] = +crimeDevidedByStates[i].ID;
                    dataset[i][1] = crimeDevidedByStates[i].State;
                    dataset[i][2] = +crimeDevidedByStates[i].Total;
                    dataset[i][3] = +crimeDevidedByStates[i].Male;
                    dataset[i][4] = +crimeDevidedByStates[i].Female;
                    dataset[i][5] = crimeDevidedByStates[i].StateFull;
                    dataset[i][6] = +crimeDevidedByStates[i].InstitutionNumber;
                    dataset[i][7] = +schoolType[i].PrivateNonProfit4YM;
                    dataset[i][8] = +schoolType[i].Public2Y;
                    dataset[i][9] = +schoolType[i].Public4YM;
                    dataset[i][10] = +schoolType[i].PrivateForProfit4YM;
                    dataset[i][11] = +schoolType[i].PrivateNonProfit2Y;
                    dataset[i][12] = +schoolType[i].PrivateForProfit2Y;
                    dataset[i][13] = +schoolType[i].Public2YL;
                    dataset[i][14] = +schoolType[i].PrivateForProfit2YL;
                    dataset[i][15] = +schoolType[i].PrivateNonProfit2YL;
                }
                
                d3.selection.prototype.moveToFront = function(){
                    return this.each(function(){
                        this.parentNode.appendChild(this);
                    });
                };
                
                //Donut Chart
                originalDataForDonut = [];
                for (var i = 0; i < 9; i++){
                    originalDataForDonut[i] = 1;
                }
                
                var donutColor = ["#fbb4ae", "#b3cde3", "#ccebc5", "#decbe4", "#fed9a6", "#ffffcc", "#e5d8bd", "#fddaec", "#f2f2f2"];
                
                var schoolTypeName = ["Private Non-Profit 4Y+", "Public 2Y", "Public 4Y+", "Private For-Profit 4Y+", "Private Non-Profit 2Y", "Private For Profit 2Y", "Public 2Y-", "Private For-Profit 2Y-", "Privat Non-Profti 2Y-"];
                
                donutChart = d3.layout.pie()
                .sort(null);
                donutData = donutChart(originalDataForDonut);
                arc = d3.svg.arc()
                .outerRadius(90)
                .innerRadius(50);
                drawDonut = svg.selectAll(".donut")
                .data(donutData)
                .enter()
                .append("path")
                .attr("d", arc)
                .attr("transform", "translate(900, 150)")
                .attr("fill", function(d, i){
                      return donutColor[i];
                })
                .style("opacity", 0)
                .on("mouseover", function(d, i){
                    if (d3.select(this).style("opacity") == 1){
                        d3.select(this).transition()
                        .duration(200)
                        .attr("fill", "orange");
                    
                        div.transition()
                        .duration(200)
                        .style("opacity", 0.8);
                    
                        div.html(schoolTypeName[i] + "<br/>" + dataForDonut[i] + " Institutions")
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                    }
                })
                .on("mouseout", function(d, i){
                    if (d3.select(this).style("opacity") == 1){
                        d3.select(this).transition()
                        .duration(500)
                        .attr("fill", donutColor[i]);
                    
                        div.transition()
                        .duration(500)
                        .style("opacity", 0);
                    }
                });
                
                //Gender Ratio Bar
                dataForGenderBar = [];
                for (var i = 0; i < crimeDevidedByStates.length; i++){
                    dataForGenderBar[i] = dataset[i][3] / dataset[i][4];
                }
                
                genderBarWidth = 350 / crimeDevidedByStates.length;
                genderBar = svg.selectAll(".chart-group")
                .selectAll(".bar")
                .data(dataForGenderBar)
                .enter()
                .append("rect");
                
                genderBarYScale = d3.scale.linear()
                .domain([0.5, 1.1])
                .range([0, 200]);
                var genderBarXAxis = svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(28, 550)")
                .style("opacity", 0)
                .call(d3.svg.axis()
                    .scale(barXScale)
                    .orient("bottom")
                    .ticks(0)
                );
                genderBarYAxisScale = d3.scale.linear()
                .domain([0.5, 1.1])
                .range([200, 0]);
                var genderBarYAxis = svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(28, 350)")
                .style("opacity", 0)
                .call(d3.svg.axis()
                    .scale(genderBarYAxisScale)
                    .orient("left")
                    .ticks(5)
                );
                
                //Crime Number Bar
                dataForCrimeBar = [];
                for (var i = 0; i < crimeDevidedByStates.length; i++){
                    dataForCrimeBar[i] = dataset[i][2];
                }
                
                crimeBarWidth = 350 / crimeDevidedByStates.length;
                crimeBar = svg.selectAll(".chart-group")
                .selectAll(".bar")
                .data(dataForCrimeBar)
                .enter()
                .append("rect");
                
                crimeBarYScale = d3.scale.linear()
                .domain([0, 680])
                .range([0, 200]);
                var crimeBarXAxis = svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(461, 550)")
                .style("opacity", 0)
                .call(d3.svg.axis()
                    .scale(barXScale)
                    .orient("bottom")
                    .ticks(0)
                );
                crimeBarYAxisScale = d3.scale.linear()
                .domain([0, 680])
                .range([200, 0]);
                var crimeBarYAxis = svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(461, 350)")
                .style("opacity", 0)
                .call(d3.svg.axis()
                    .scale(crimeBarYAxisScale)
                    .orient("left")
                    .ticks(5)
                );
                
                //Institution Number Bar
                dataForInstitutionBar = [];
                for (var i = 0; i < crimeDevidedByStates.length; i++){
                    dataForInstitutionBar[i] = dataset[i][6];
                }
                
                institutionBarWidth = 350 / crimeDevidedByStates.length;
                institutionBar = svg.selectAll(".chart-group")
                .selectAll(".bar")
                .data(dataForInstitutionBar)
                .enter()
                .append("rect");
                
                institutionBarYScale = d3.scale.linear()
                .domain([0, 160])
                .range([0, 200]);
                var institutionBarXAxis = svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(894, 550)")
                .style("opacity", 0)
                .call(d3.svg.axis()
                    .scale(barXScale)
                    .orient("bottom")
                    .ticks(0)
                );
                institutionBarYAxisScale = d3.scale.linear()
                .domain([0, 160])
                .range([200, 0]);
                var institutionBarYAxis = svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(894, 350)")
                .style("opacity", 0)
                .call(d3.svg.axis()
                    .scale(institutionBarYAxisScale)
                    .orient("left")
                    .ticks(5)
                );
                
                // Big U.S. Map
                USMap = svg.selectAll("pathUS")
                .data(states.features)
                .enter()
                .append("path")
                .attr("stroke-width", 1)
                .attr("stroke", "#ccc")
                .attr("d", path)
                .attr("id", function(d){
                      return "s" + d.id;
                })
                .on("mouseover", function(d, i){
                    if (d3.select(this).style("opacity") == 1){
                        d3.select(this).transition()
                        .duration(200)
                        .attr("fill", "orange");
                    
                        div.transition()
                        .duration(200)
                        .style("opacity", 0.8);
                    
                        for (var i = 0; i < dataset.length; i++){
                            if (d.id == dataset[i][0]){
                                div.html(d.properties.name + "<br/>" + dataset[i][2] + " Crimes")
                                .style("left", (d3.event.pageX) + "px")
                                .style("top", (d3.event.pageY - 28) + "px");
                                colorFlag = dataset[i][2];
                            }
                        }
                    }
                })
                .on("mouseout", function(d){
                    if (d3.select(this).style("opacity") == 1){
                        d3.select(this).transition()
                        .duration(500)
                        .attr("fill", color(colorFlag));
                    
                        div.transition()
                        .duration(500)
                        .style("opacity", 0);
                    }
                })
                .on("click", function(d, i){
                    if (d3.select(this).style("opacity") == 1){
                        for (var i = 0; i < crimeDevidedByStates.length; i++){
                            d3.select("#ss" + crimeDevidedByStates[i].ID).moveToFront();
                            d3.select("#s" + crimeDevidedByStates[i].ID).attr("fill", color(+crimeDevidedByStates[i].Total));
                        }
                    
                        for (var i = 0; i < dataset.length; i++){
                            if(d.id == dataset[i][0]){
                                dataForDonut[0] = dataset[i][7];
                                dataForDonut[1] = dataset[i][8];
                                dataForDonut[2] = dataset[i][9];
                                dataForDonut[3] = dataset[i][10];
                                dataForDonut[4] = dataset[i][11];
                                dataForDonut[5] = dataset[i][12];
                                dataForDonut[6] = dataset[i][13];
                                dataForDonut[7] = dataset[i][14];
                                dataForDonut[8] = dataset[i][15];
                                genderBarFlag = i;
                                crimeBarFlag = i;
                                institutionBarFlag = i;
                            }
                        }
                    
                        USMap.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        div.transition()
                        .duration(500)
                        .style("opacity", 0);
                    
                        USMapS.transition()
                        .duration(500)
                        .style("opacity", 1);
                    
                        //Donut Chart
                        donutData = donutChart(dataForDonut);
                        drawDonut.data(donutData)
                        .attr("d", arc);
                    
                        //Gender Ratio Bar
                        genderBar.transition()
                        .duration(500)
                        .each("start", function(){
                            d3.select(this)
                            .attr("y", 550 - 200)
                            .attr("height", 200)
                            .attr("fill", "orange");
                        })
                        .delay(function(d, i){
                            return i / dataForGenderBar.length * 500;
                        })
                        .attr("x", function(d, i){
                            return i * genderBarWidth + 30;
                        })
                        .attr("width", genderBarWidth - 2)
                        .attr("id", function(d, i){
                            return "genderBar" + i;
                        })
                        .each("end", function(){
                            d3.select(this)
                            .transition()
                            .duration(300)
                            .attr("y", function(d){
                                return 550 - genderBarYScale(d);
                            })
                            .attr("height", function(d){
                                return genderBarYScale(d);
                            })
                            .attr("fill", function(d){
                                if (d3.select(this).attr("id").substr(9) != genderBarFlag){
                                    return "rgba(0, 0, 255, 0.5)";
                                }
                                else{
                                    return "orange";
                                }
                            });
                            d3.select(this)
                            .on("mouseover", function(d, i){
                                if (d3.select(this).style("opacity") == 1){
                                    var tip = d3.select(this).attr("id").substr(9);
                                    tip = +tip;
                                    for (var i = 0; i < dataset.length; i++){
                                        if (i != tip){
                                            d3.select("#genderBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                        }
                                    }
                                    d3.select(this).attr("fill", "orange");
                                    div.transition()
                                    .duration(200)
                                    .style("opacity", 0.8);
                                    div.html(dataset[tip][5] + "<br/>"  + d)
                                    .style("left", (d3.event.pageX) + "px")
                                    .style("top", (d3.event.pageY - 28) + "px");
                                
                                    for (var i = 0; i < dataset.length; i++){
                                        if (smallMapFlag == dataset[i][0]){
                                            d3.select("#ss" + smallMapFlag).attr("fill", color(+crimeDevidedByStates[i].Total));
                                            d3.select("#crimeBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                            d3.select("#institutionBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                        }
                                    }
                                
                                    for (var i = 0; i < dataset.length; i++){
                                        if (i == tip){
                                            d3.select("#ss" + crimeDevidedByStates[i].ID).attr("fill", "orange");
                                            d3.select("#crimeBar" + i).attr("fill", "orange");
                                            d3.select("#institutionBar" + i).attr("fill", "orange");
                                            dataForDonut[0] = dataset[i][7];
                                            dataForDonut[1] = dataset[i][8];
                                            dataForDonut[2] = dataset[i][9];
                                            dataForDonut[3] = dataset[i][10];
                                            dataForDonut[4] = dataset[i][11];
                                            dataForDonut[5] = dataset[i][12];
                                            dataForDonut[6] = dataset[i][13];
                                            dataForDonut[7] = dataset[i][14];
                                            dataForDonut[8] = dataset[i][15];
                                        }
                                    }
                                
                                    donutData = donutChart(dataForDonut);
                                    drawDonut.data(donutData)
                                    .attr("d", arc);
                                }
                            })
                            .on("mouseout", function(d){
                                if (d3.select(this).style("opacity") == 1){
                                    d3.select(this).attr("fill", "rgba(0, 0, 255, 0.5)");
                                    div.transition()
                                    .duration(500)
                                    .style("opacity", 0);
                                    var tip = d3.select(this).attr("id").substr(9);
                                    tip = +tip;
                                    for (var i = 0; i < dataset.length; i++){
                                        if (i == tip){
                                            d3.select("#ss" + crimeDevidedByStates[i].ID).attr("fill", color(+crimeDevidedByStates[i].Total));
                                            d3.select("#crimeBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                            d3.select("#institutionBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                        }
                                    }
                                
                                }
                            });
                        });
                            
                        //Crime Bar
                        crimeBar.transition()
                        .duration(500)
                        .each("start", function(){
                            d3.select(this)
                            .attr("y", 550 - 200)
                            .attr("height", 200)
                            .attr("fill", "orange");
                        })
                        .delay(function(d, i){
                            return i / dataForCrimeBar.length * 500;
                        })
                        .attr("x", function(d, i){
                            return i * crimeBarWidth + 463;
                        })
                        .attr("width", crimeBarWidth - 2)
                        .attr("id", function(d, i){
                            return "crimeBar" + i;
                        })
                        .each("end", function(){
                            d3.select(this)
                            .transition()
                            .duration(300)
                            .attr("y", function(d){
                                return 550 - crimeBarYScale(d);
                            })
                            .attr("height", function(d){
                                return crimeBarYScale(d);
                            })
                            .attr("fill", function(d){
                                if (d3.select(this).attr("id").substr(8) != crimeBarFlag){
                                    return "rgba(0, 0, 255, 0.5)";
                                }
                                else{
                                    return "orange";
                                }
                            });
                            d3.select(this)
                            .on("mouseover", function(d, i){
                                if (d3.select(this).style("opacity") == 1){
                                    var tip = d3.select(this).attr("id").substr(8);
                                    tip = +tip;
                                    for (var i = 0; i < dataset.length; i++){
                                        if (i != tip){
                                            d3.select("#crimeBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                        }
                                    }
                                    d3.select(this).attr("fill", "orange");
                                    div.transition()
                                    .duration(200)
                                    .style("opacity", 0.8);
                                    div.html(dataset[tip][5] + "<br/>"  + d + " Crimes")
                                    .style("left", (d3.event.pageX) + "px")
                                    .style("top", (d3.event.pageY - 28) + "px");
                                
                                    for (var i = 0; i < dataset.length; i++){
                                        if (smallMapFlag == dataset[i][0]){
                                            d3.select("#ss" + smallMapFlag).attr("fill", color(+crimeDevidedByStates[i].Total));
                                            d3.select("#genderBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                            d3.select("#institutionBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                        }
                                    }
                                
                                    for (var i = 0; i < dataset.length; i++){
                                        if (i == tip){
                                            d3.select("#ss" + crimeDevidedByStates[i].ID).attr("fill", "orange");
                                            d3.select("#genderBar" + i).attr("fill", "orange");
                                            d3.select("#institutionBar" + i).attr("fill", "orange");
                                            dataForDonut[0] = dataset[i][7];
                                            dataForDonut[1] = dataset[i][8];
                                            dataForDonut[2] = dataset[i][9];
                                            dataForDonut[3] = dataset[i][10];
                                            dataForDonut[4] = dataset[i][11];
                                            dataForDonut[5] = dataset[i][12];
                                            dataForDonut[6] = dataset[i][13];
                                            dataForDonut[7] = dataset[i][14];
                                            dataForDonut[8] = dataset[i][15];
                                        }
                                    }
                                
                                    donutData = donutChart(dataForDonut);
                                    drawDonut.data(donutData)
                                    .attr("d", arc);
                                }
                            })
                            .on("mouseout", function(d){
                                if (d3.select(this).style("opacity") == 1){
                                    d3.select(this).attr("fill", "rgba(0, 0, 255, 0.5)");
                                    div.transition()
                                    .duration(500)
                                    .style("opacity", 0);
                                    var tip = d3.select(this).attr("id").substr(8);
                                    tip = +tip;
                                    for (var i = 0; i < dataset.length; i++){
                                        if (i == tip){
                                            d3.select("#ss" + crimeDevidedByStates[i].ID).attr("fill", color(+crimeDevidedByStates[i].Total));
                                            d3.select("#genderBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                            d3.select("#institutionBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                        }
                                    }
                                }
                            });
                        });
                    
                        //Institution Bar
                        institutionBar.transition()
                        .duration(500)
                        .each("start", function(){
                            d3.select(this)
                            .attr("y", 550 - 200)
                            .attr("height", 200)
                            .attr("fill", "orange");
                        })
                        .delay(function(d, i){
                            return i / dataForInstitutionBar.length * 500;
                        })
                        .attr("x", function(d, i){
                            return i * institutionBarWidth + 896;
                        })
                        .attr("width", institutionBarWidth - 2)
                        .attr("id", function(d, i){
                            return "institutionBar" + i;
                        })
                        .each("end", function(){
                            d3.select(this)
                            .transition()
                            .duration(300)
                            .attr("y", function(d){
                                return 550 - institutionBarYScale(d);
                            })
                            .attr("height", function(d){
                                return institutionBarYScale(d);
                            })
                            .attr("fill", function(d){
                                if (d3.select(this).attr("id").substr(14) != institutionBarFlag){
                                    return "rgba(0, 0, 255, 0.5)";
                                }
                                else{
                                    return "orange";
                                }
                            });
                            d3.select(this)
                            .on("mouseover", function(d, i){
                                if (d3.select(this).style("opacity") == 1){
                                    var tip = d3.select(this).attr("id").substr(14);
                                    tip = +tip;
                                    for (var i = 0; i < dataset.length; i++){
                                        if (i != tip){
                                            d3.select("#institutionBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                        }
                                    }
                                    d3.select(this).attr("fill", "orange");
                                    div.transition()
                                    .duration(200)
                                    .style("opacity", 0.8);
                                    div.html(dataset[tip][5] + "<br/>"  + d + " Institutions")
                                    .style("left", (d3.event.pageX) + "px")
                                    .style("top", (d3.event.pageY - 28) + "px");
                                
                                    for (var i = 0; i < dataset.length; i++){
                                        if (smallMapFlag == dataset[i][0]){
                                            d3.select("#ss" + smallMapFlag).attr("fill", color(+crimeDevidedByStates[i].Total));
                                            d3.select("#genderBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                            d3.select("#crimeBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                        }
                                    }
                                
                                    for (var i = 0; i < dataset.length; i++){
                                        if (i == tip){
                                            d3.select("#ss" + crimeDevidedByStates[i].ID).attr("fill", "orange");
                                            d3.select("#genderBar" + i).attr("fill", "orange");
                                            d3.select("#crimeBar" + i).attr("fill", "orange");
                                            dataForDonut[0] = dataset[i][7];
                                            dataForDonut[1] = dataset[i][8];
                                            dataForDonut[2] = dataset[i][9];
                                            dataForDonut[3] = dataset[i][10];
                                            dataForDonut[4] = dataset[i][11];
                                            dataForDonut[5] = dataset[i][12];
                                            dataForDonut[6] = dataset[i][13];
                                            dataForDonut[7] = dataset[i][14];
                                            dataForDonut[8] = dataset[i][15];
                                        }
                                    }
                                
                                    donutData = donutChart(dataForDonut);
                                    drawDonut.data(donutData)
                                    .attr("d", arc);
                                }
                            })
                            .on("mouseout", function(d){
                                if (d3.select(this).style("opacity") == 1){
                                    d3.select(this).attr("fill", "rgba(0, 0, 255, 0.5)");
                                    div.transition()
                                    .duration(500)
                                    .style("opacity", 0);
                                    var tip = d3.select(this).attr("id").substr(14);
                                    tip = +tip;
                                    for (var i = 0; i < dataset.length; i++){
                                        if (i == tip){
                                            d3.select("#ss" + crimeDevidedByStates[i].ID).attr("fill", color(+crimeDevidedByStates[i].Total));
                                            d3.select("#genderBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                            d3.select("#crimeBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                        }
                                    }
                                }
                            });
                        });

                    
                        //Opacity
                        genderBarXAxis.transition()
                        .duration(500)
                        .style("opacity", 1);
                        genderBarYAxis.transition()
                        .duration(500)
                        .style("opacity", 1);
                        genderBar.style("opacity", 1);
                        genderBarXAxis.moveToFront();
                        genderBarYAxis.moveToFront();
                        genderBar.moveToFront();
                    
                        crimeBarXAxis.transition()
                        .duration(500)
                        .style("opacity", 1);
                        crimeBarYAxis.transition()
                        .duration(500)
                        .style("opacity", 1);
                        crimeBar.style("opacity", 1);
                        crimeBarXAxis.moveToFront();
                        crimeBarYAxis.moveToFront();
                        crimeBar.moveToFront();
                    
                        institutionBarXAxis.transition()
                        .duration(500)
                        .style("opacity", 1);
                        institutionBarYAxis.transition()
                        .duration(500)
                        .style("opacity", 1);
                        institutionBar.style("opacity", 1);
                        institutionBarXAxis.moveToFront();
                        institutionBarYAxis.moveToFront();
                        institutionBar.moveToFront();
                    
                        drawDonut.transition()
                        .duration(500)
                        .style("opacity", 1);
                        drawDonut.moveToFront();
                    
                        d3.select("#ss" + d.id).attr("fill", "orange");
                        smallMapFlag = d.id;
                    
                    }
                });
                
                for (var i = 0; i < crimeDevidedByStates.length; i++){
                    d3.select("#s" + crimeDevidedByStates[i].ID).attr("fill", color(+crimeDevidedByStates[i].Total));
                }
                
                //Small U.S. Map
                projection2 = d3.geo.albersUsa()
                .translate([350, 150])
                .scale([600]);
                
                path2 = d3.geo.path().projection(projection2);
                
                USMapS = svg.selectAll("pathUS")
                .data(states.features)
                .enter()
                .append("path")
                .attr("stroke-width", 1)
                .attr("stroke", "#ccc")
                .attr("d", path2)
                .attr("id", function(d){
                      return "ss" + d.id;
                })
                .style("opacity", 0)
                .on("mouseover", function(d, i){
                    if (d3.select(this).style("opacity") == 1){
                        d3.select(this).transition()
                        .duration(200)
                        .attr("fill", "orange");
                    
                        div.transition()
                        .duration(200)
                        .style("opacity", 0.8);
                    
                        for (var i = 0; i < dataset.length; i++){
                            if (d.id == dataset[i][0]){
                                div.html(d.properties.name + "<br/>" + dataset[i][2] + " Crimes")
                                .style("left", (d3.event.pageX) + "px")
                                .style("top", (d3.event.pageY - 28) + "px");
                                colorFlag = dataset[i][2];
                                dataForDonut[0] = dataset[i][7];
                                dataForDonut[1] = dataset[i][8];
                                dataForDonut[2] = dataset[i][9];
                                dataForDonut[3] = dataset[i][10];
                                dataForDonut[4] = dataset[i][11];
                                dataForDonut[5] = dataset[i][12];
                                dataForDonut[6] = dataset[i][13];
                                dataForDonut[7] = dataset[i][14];
                                dataForDonut[8] = dataset[i][15];
                                genderBarFlag = i;
                            }
                        }
                        for (var i = 0; i < dataset.length; i++){
                            if (i != genderBarFlag){
                                d3.select("#genderBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                d3.select("#crimeBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                                d3.select("#institutionBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                            }
                            else{
                                d3.select("#genderBar" + i).attr("fill", "orange");
                                d3.select("#crimeBar" + i).attr("fill", "orange");
                                d3.select("#institutionBar" + i).attr("fill", "orange");
                            }
                        }
                        for (var i = 0; i < dataset.length; i++){
                            if (smallMapFlag == dataset[i][0]){
                                d3.select("#ss" + smallMapFlag).attr("fill", color(+crimeDevidedByStates[i].Total));
                            }
                        }
                    
                        donutData = donutChart(dataForDonut);
                        drawDonut.data(donutData)
                        .attr("d", arc);
                    }
                })
                .on("mouseout", function(d){
                    if (d3.select(this).style("opacity") == 1){
                        d3.select(this).transition()
                        .duration(500)
                        .attr("fill", color(colorFlag));
                    
                        div.transition()
                        .duration(500)
                        .style("opacity", 0);
                    
                        for (var i = 0; i < dataset.length; i++){
                            d3.select("#genderBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                            d3.select("#crimeBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                            d3.select("#institutionBar" + i).attr("fill", "rgba(0, 0, 255, 0.5)");
                        }
                    
                    }
                })
                .on("click", function(d){
                    if (d3.select(this).style("opacity") == 1){
                        for (var i = 0; i < crimeDevidedByStates.length; i++){
                            d3.select("#s" + crimeDevidedByStates[i].ID).moveToFront();
                            d3.select("#ss" + crimeDevidedByStates[i].ID).attr("fill", color(+crimeDevidedByStates[i].Total));
                        }
                    
                        USMap.transition()
                        .duration(500)
                        .style("opacity", 1);
                    
                        div.transition()
                        .duration(500)
                        .style("opacity", 0);
                    
                        USMapS.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        genderBar.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        genderBarXAxis.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        genderBarYAxis.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        crimeBar.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        crimeBarXAxis.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        crimeBarYAxis.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        institutionBar.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        institutionBarXAxis.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        institutionBarYAxis.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                        drawDonut.transition()
                        .duration(600)
                        .style("opacity", 0);
                    
                    }
                });
                
                for (var i = 0; i < crimeDevidedByStates.length; i++){
                    d3.select("#ss" + crimeDevidedByStates[i].ID).attr("fill", color(+crimeDevidedByStates[i].Total));
                }
                
                for (var i = 0; i < crimeDevidedByStates.length; i++){
                    d3.select("#s" + crimeDevidedByStates[i].ID).moveToFront();
                }
                
                //SVG2
                gFilter.selectAll("pathUS")
                .data(states.features)
                .enter()
                .append("path")
                .style("stroke-width", 1)
                .style("stroke", "grey")
                .attr("d", pathFilter)
                .style("fill", function(d){
                    for (i = 0; i < crimeDevidedByStates.length; i++){
                        if (crimeDevidedByStates[i].StateFull == d.properties.name){
                            return colorFilter(crimeDevidedByStates[i].InstitutionNumber);
                        }
                    }
                })
                .style("opacity", 1)
                .on("click", clicked)
                .on("mouseover", function(d){
                    
                    num = document.getElementById("nNumber").value;
                    type = document.getElementById("nType").value;
                    
                    var institution = new Array();
                    var crimeNum = new Array();
                    var state;
                    
                    for (i = 0; i < crimeDevidedByStates.length; i++){
                    
                        if (crimeDevidedByStates[i].StateFull == d.properties.name){
                            state = crimeDevidedByStates[i].State;
                            divFilter.html(d.properties.name + "<br/>" + crimeDevidedByStates[i].InstitutionNumber + " Institutions")
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 25) + "px");
                        }
                    }
                    
                    for(i = 0; i < datasetFull.length; i++){
                        if(datasetFull[i].State == state){
                    
                            if (num == "female" && Number(datasetFull[i].women_total) > Number(datasetFull[i].men_total)){}
                            else if (num == "male" && Number(datasetFull[i].women_total) < Number(datasetFull[i].men_total)){}
                            else continue;
                    
                            if (datasetFull[i].Sector_desc.substring(0, 6) == type || datasetFull[i].Sector_desc.substring(0, 7) == type){
                                institution.push(datasetFull[i].INSTNM+" ("+datasetFull[i].BRANCH+")");
                                crimeNum.push(Number(sum[i].sum) - 3);
                            }
                        }
                    }
                    
                    //Bubble Sort
                    for (i = 0; i < crimeNum.length; i++){
                        for (var j = i; j < crimeNum.length; j++){
                            if (crimeNum[i] > crimeNum[j]){
                                var temp1 = crimeNum[i];
                                crimeNum[i] = crimeNum[j];
                                crimeNum[j] = temp1;
                           
                               var temp2 = institution[i];
                               institution[i] = institution[j];
                               institution[j] = temp2;
                            }
                        }
                    }
                    
                    svgFilter.selectAll(".instName").remove();
                    
                    svgFilter.append("text")
                    .attr("class", "instName")
                    .attr("x", 792)
                    .attr("y", 370)
                    .style("font-size", 12)
                    .text("Top 5 Safest Institutions")
                    .attr("pointer-events", "none");
                    
                    for (i = 0; i < crimeNum.length; i++){
                        if (i > 4) {break;}
                        svgFilter.append("text")
                        .attr("class", "instName")
                        .attr("x", 792)
                        .attr("y", 400 + i*30)
                        .style("font-size", 11)
                        .text(institution[i])
                        .attr("pointer-events", "none");
                    }
                    
                });
                
                svgFilter.append("rect")
                .attr("x", 772)
                .attr("y", 340)
                .attr("width", 500)
                .attr("height", 220)
                .attr("r", 5)
                .style("fill", "white")
                .style("opacity", 0.7) 
                .attr("pointer-events", "none");
                
                function clicked(d) {
                    
                    var x, y, k;
                    if (d && centeredFilter !== d){
                        var centroid = pathFilter.centroid(d);
                        x = centroid[0];
                        y = centroid[1];
                        k = 3.5;
                        centeredFilter = d;
                        svgFilter.selectAll("path").transition().style("opacity", 0.3).duration(500);
                        d3.select(this).transition().style("opacity", 1).duration(500).delay(500);
                    }
                    else{
                        x = widthFilter / 2;
                        y = heightFilter / 2;
                        k = 1;
                        centeredFilter = null;
                        svgFilter.selectAll("path").transition().style("opacity", 1).duration(1000);
                    }
                    gFilter.selectAll("path")
                    .classed("active", centeredFilter && function(d) { return d === centeredFilter; });
                    gFilter.transition()
                    .duration(750)
                    .attr("transform", "translate(" + widthFilter / 2 + "," + heightFilter / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
                    .style("stroke-width", 1.5 / k + "px");
                }

            }
        
            for(i = 0; i < 8; i++){
                svgFilter.append("rect")
                .attr("x", 30 + 20*i)
                .attr("y", heightFilter - 25)
                .attr("width", 20)
                .attr("height", 10)
                .style("stroke", "grey")
                .attr("fill", colorFilter(i*20));
            
                svgFilter.append("text")
                .attr("x", 30 + 20*i)
                .attr("y", heightFilter)
                .style("font-size", 10)
                .text(i*20);
            }
            svgFilter.append("text")
            .attr("x", 190)
            .attr("y", heightFilter)
            .style("font-size", 10)
            .text(160);
        
        </script>
        <select id="nNumber" style="display: inline-block; width: 100px; text-align: right; margin-left: 39px;" > <option value ="female">More Female</option> <option value ="male">More Male</option></select>
        
        <select id="nType" style="display: inline-block; width: 100px; text-align: right; margin-left: 39px;" > <option value ="Public">Public</option> <option value ="Private">Private</option></select>
    </body>
</html>
